for $b in doc('agencias.xml')//Inmobiliarias/Inmobiliaria where $b/provincia = "Madrid" order by $b/nombre return <agencia> {$b/nombre} <anuncios> {for $a in doc('inmuebles.xml')//anuncio where $a/@agencia = $b/@id return <id> {$a/@id} </id>} </anuncios> </agencia>
for $b in doc('inmuebles.xml')//inmuebles/anuncio where every $a in $b satisfies ($b/inmueble/@tipo = "piso") and $b/opcionales/numHabs >= 2 order by $b/@id return <inmueble> <id>{$b/@id}</id> <info> {$b/inmueble/localidad} {$b/inmueble/provincia} {$b/inmueble/metros2} {$b/inmueble/precio} <estado> {$b/inmueble/@estado} </estado> <agencia> {$b/@agencia} </agencia> <calefaccion> {if (not(exists($b/opcionales/calefaccion))) then "no" else  $b/opcionales/calefaccion} </calefaccion> </info> </inmueble>


for $b in doc('inmuebles.xml')//inmuebles/anuncio where $b/inmueble/@tipo == "casa" AND $b/inmueble/cp == 28210 AND $b/inmueble/precio < 500000 order by $b/inmueble/precio group $b as $bb by $b/@agencia as $z return  $bb/id



Query 1:
for $b in doc('agencias.xml')//Inmobiliarias/Inmobiliaria 
	where $b/provincia = "Madrid"
	order by $b/nombre 
	return <agencia> 
		{$b/nombre} 
		<anuncios> 
			{for $a in doc('inmuebles.xml')//anuncio 
				where $a/@agencia = $b/@id
				return <id> 
					{$a/@id} 
				</id>} 
		</anuncios> 
	</agencia>
	
	
Query 2:
for $b in doc('inmuebles.xml')//inmuebles/anuncio 
    where every $a in $b satisfies ($b/inmueble/@tipo = "piso") and $b/opcionales/numHabs >= 2 
    order by $b/@id 
    return <inmueble> 
        <id>{$b/@id}</id>
        <info> 
            {$b/inmueble/localidad}
            {$b/inmueble/provincia}
    		{$b/inmueble/metros2}
    		{$b/inmueble/precio}
    		<estado>
    			{$b/inmueble/@estado}
    		</estado>
    		<agencia>
    			{$b/@agencia}
    		</agencia> 
    		<calefaccion>
    			{if (not(exists($b/opcionales/calefaccion))) then "no" else  $b/opcionales/calefaccion}
    		</calefaccion>
        </info>
    </inmueble>